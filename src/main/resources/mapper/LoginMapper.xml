<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.rainier.mapper.LoginMapper" >

  <select id="getUserByLogin" parameterType="map" resultType="com.rainier.model.User">
        SELECT
        u.id,
        u.`name`,
        u.state,
        u.last_login_time,
        u.email,
        u.phone,
        GROUP_CONCAT( r.`name` ) AS rname
    FROM
        `user` u,
        userrole ur,
        role r
    WHERE
        u.id = ur.userid
        AND ur.roleid = r.id and u.`name` = #{name,jdbcType=VARCHAR} and u.`password` = #{password,jdbcType=VARCHAR}
  </select>

  <update id="updateByPrimaryKeySelective">
    update `user` set last_login_time = #{user.last_login_time} where id = #{user.id}
  </update>

  <resultMap id="BaseResultMap" type="com.rainier.model.Menu" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="parentid" property="parentid" jdbcType="INTEGER" />
    <result column="parentName" property="parentName" jdbcType="VARCHAR" />
    <result column="isDisplay" property="isDisplay" jdbcType="BIT" />
    <result column="displayOrder" property="displayOrder" jdbcType="INTEGER" />
    <result column="url" property="url" jdbcType="VARCHAR" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="level" property="level" jdbcType="INTEGER" />
  </resultMap>

  <select id="getModuleByLevelType" parameterType="map" resultMap="BaseResultMap">
    SELECT * FROM `menu` /*where isdisplay = 1*/
  </select>

  <select id="selModulesAll"  resultMap="BaseResultMap">
    SELECT * FROM `menu`
    WHERE id IN (
            SELECT DISTINCT ( rolemenu.menuid )
            FROM
                rolemenu
            WHERE
                rolemenu.roleid IN ( SELECT userrole.roleid FROM userrole WHERE userrole.userid = #{id} )
        )
    /*AND modules.IsDisplay = 1*/
    ORDER BY displayOrder
  </select>
</mapper>